<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=arrow_back_ios_new,create_new_folder,crown,filter_list,folder,grid_view,keyboard_double_arrow_right,search,south,swap_vert,view_agenda" />
    <title>Mobile File Management Interface</title>
    <style>
        /* Center the mobile view on the screen */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            /* Light gray background */
            transition: background-color 0.3s ease, color 0.3s ease;
            /* Smooth transition for mode switch */
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #222 !important;
        }

        /* Mobile View Container */
        .mobile-view {
            width: 375px;
            height: 98vh;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        body.dark-mode .mobile-view {
            background-color: #333 !important;
            border-color: #555;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        /* Header */
        header {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            transition: background-color 0.3s ease, border-bottom-color 0.3s ease;
        }

        body.dark-mode header {
            background-color: #444 !important;
            border-bottom-color: #555;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 10px 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 5px;
        }

        body.dark-mode .header-top {
            border-bottom-color: #555;
        }

        .toggle-label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
            transition: color 0.3s ease;
        }

        body.dark-mode .toggle-label {
            color: #ddd !important;
        }

        /* Custom Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 30px;
            height: 16px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
            /* Ensure it doesn't interfere with layout */
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 13px;
            width: 13px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #4285f4 !important;
        }

        input:checked+.slider:before {
            transform: translateX(14px) !important;
        }

        .toggle-right {
            display: flex;
            align-items: center;
        }

        .double-arrow {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;

            transition: color 0.3s ease;
        }

        .double-arrow .material-symbols-outlined {
            font-size: 28px;
            font-variation-settings:
                'FILL' 0,
                'wght' 100,
                'GRAD' 0,
                'opsz' 24
        }

        body.dark-mode .double-arrow {
            color: #ddd !important;
        }

        .header-bottom {
            display: flex;
            align-items: center;
            padding: 10px 10px 10px 10px;
        }

        .navigation button {
            display: flex;
            align-items: center;
            background: none;
            border: none;
            margin-right: 20px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .header-bottom .navigation .material-symbols-outlined {
            font-size: 20px;
            font-variation-settings:
                'FILL' 0,
                'wght' 100,
                'GRAD' 0,
                'opsz' 24
        }

        body.dark-mode .navigation button {
            color: #ddd !important;
        }

        .project-dropdown {
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: flex-end;
            flex-grow: 1;
            justify-content: flex-start;
            position: relative;
            cursor: pointer;
            color: #333;
            transition: color 0.3s ease;
        }

        .project-dropdown .material-icons {
            font-size: 16px;
            color: #ccc;
        }

        body.dark-mode .project-dropdown {
            color: #ddd !important;
        }

        .project-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px;
            list-style: none;
            z-index: 1000;
            display: none;
            min-width: 150px;
            transition: background-color 0.3s ease;
        }

        body.dark-mode .project-dropdown-menu {
            background-color: #555 !important;
        }

        .project-dropdown-menu li {
            padding: 5px 0;
            cursor: pointer;
        }

        .project-dropdown-menu li:hover {
            background-color: #4285f4;
        }

        .icons {
            display: flex;
            position: relative;
            /* For positioning the search bar */
        }

        .icons button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s ease;
        }

        .icons button .material-symbols-outlined {
            font-size: 22px;
            font-variation-settings:
                'FILL' 0,
                'wght' 320,
                'GRAD' 0,
                'opsz' 24
        }

        body.dark-mode .icons button {
            color: #ddd !important;
        }

        /* Sort/Filter Dropdown */
        .sort-filter-menu {
            position: fixed;
            top: 16%;
            right: 30%;
            background-color: #333;
            color: white;
            padding: 10px;
            list-style: none;
            z-index: 1000;
            display: none;
            min-width: 150px;
            transition: background-color 0.3s ease;
        }

        body.dark-mode .sort-filter-menu {
            background-color: #555 !important;
        }

        .sort-filter-menu li {
            padding: 5px 0;
            cursor: pointer;
            font-size: 14px;
        }

        .sort-filter-menu li.title {
            font-weight: bold;
            cursor: default;
        }

        .sort-filter-menu li:hover:not(.title) {
            background-color: #4285f4;
        }

        /* Search Bar */
        .search-bar {
            display: none;
            position: absolute;
            top: 100%;
            /* Position below the Search icon */
            right: 30px;
            /* Align with the Search icon, accounting for other icons */
            background-color: #fafafa;
            padding: 5px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 200px;
            /* Fixed width to fit in the header */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .search-details {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        body.dark-mode .search-bar {
            background-color: #444 !important;
            border-color: #555;
        }

        .search-bar input {
            width: calc(100% - 12px);
            /* Adjust for the Clear button */
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            background-color: #fff;
            color: #555;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #ccc;
        }

        body.dark-mode .search-bar input {
            background-color: #555 !important;
            border-color: #666;
            color: #ddd !important;
        }

        body.dark-mode .search-bar input::placeholder {
            color: #aaa !important;
        }

        .search-bar button {
            margin-left: 5px;
            padding: 5px 8px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .search-bar button:hover {
            background-color: #3267d6;
        }

        /* Content Area */
        .content {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 375px;
            background-color: #fafafa;
            padding: 10px;
            overflow-y: auto;
            display: none;
            /* Hidden until folders/files are created */
            transition: background-color 0.3s ease;
        }

        body.dark-mode .sidebar {
            background-color: #444 !important;
        }

        .file-structure {
            list-style: none;
            padding: 0;
        }

        .file-structure.list-view>li {
            margin: 5px 0;
        }

        .file-structure.list-view ul {
            padding-left: 20px;
            /* Indent all children in List View */
        }

        /* draggable span */
        .file-structure.list-view li ul li.file .draggable-file-span {
            position: relative;
            width: inherit;
            display: flex;
        }

        .file-structure.list-view li ul li.file .draggable-file-span .icon-name-div {
            flex: 2;
            display: flex;
        }

        .file-structure.list-view li ul li.file .draggable-file-span .favorite-color-div {
            position: absolute;
            right: -7px;
            flex: 1;
            display: flex;
            justify-content: flex-end;
            padding-right: 10px;
        }

        .file-structure.list-view li ul li.file .draggable-file-span .icon {
            display: flex;
            align-items: center;
        }

        .file-structure.grid-view ul {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 5px;
            list-style: none;
        }

        .file-structure.grid-view>li,
        .file-structure.grid-view ul>li {
            width: fit-content;
            text-align: center;
        }

        .folder>span {
            cursor: pointer;
            display: flex;
            padding: 5px;
            border-radius: 4px;
            transition: transform 0.2s ease, background-color 0.2s ease;
            color: #000;
            transition: color 0.3s ease;
        }

        .arrow-name-div {
            flex: 2;
            display: flex;
        }

        .folder-favorite-color-div {
            position: absolute;
            right: 0;
            flex: 1;
            display: flex;
            justify-content: flex-end;
            padding-right: 10px;
        }

        body.dark-mode .folder>span {
            color: #ddd !important;
        }

        body.dark-mode .folder-list-name {
            color: #ddd !important;
        }

        .file {
            display: flex;
            width: 100%;
            align-items: center;
            padding: 5px;
            color: #000;
            transition: color 0.3s ease;
        }

        body.dark-mode .file {
            color: #ddd !important;
        }

        .file-structure.grid-view .folder>span,
        .file-structure.grid-view .file {
            flex-direction: column;
            align-items: center;
            padding: 5px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #fff;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        body.dark-mode .file-structure.grid-view .folder>span,
        body.dark-mode .file-structure.grid-view .file {
            border-color: #555 !important;
            background-color: #555 !important;
        }

        .file-structure.grid-view .folder .arrow {
            font-size: 12px;
            margin-bottom: 5px;
        }

        .file-structure.grid-view .icon,
        .file-structure.grid-view .folder-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .file-structure.grid-view .file-name,
        .file-structure.grid-view .folder-name {
            font-size: 12px;
            word-break: break-all;
        }

        .arrow {
            display: inline-block;
            width: 12px;
            color: #999;
            font-size: 12px;
            margin-right: 3px;
        }

        .file .icon {
            margin-right: 8px;
        }

        .file-list-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            transition: color 0.3s ease;
        }

        .list-name {
            padding-bottom: 10px;
        }

        .main-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            transition: background-color 0.3s ease;
        }

        body.dark-mode .main-area {
            background-color: #333 !important;
        }

        .drop-zone {
            border: 2px dashed #00a0f6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            width: 84%;
            height: 89%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #000;
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode .drop-zone {
            border-color: #3267d6 !important;
            color: #ddd !important;
        }

        .drop-zone .icon {
            width: 70px;
            height: 70px;
            background-color: #e8f0fe;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: #00a0f6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .drop-zone .icon .material-symbols-outlined {
            font-size: 40px;
            font-variation-settings:
                'FILL' 0,
                'wght' 100,
                'GRAD' 0,
                'opsz' 24
        }

        .drop-zone p {
            font-size: 12px;
            font-weight: 500;
            color: #00a0f6;
        }

        body.dark-mode .drop-zone .icon {
            background-color: #3267d6 !important;
            color: #ddd !important;
        }

        .drop-zone.dragover {
            background-color: #e8f0fe;
            transform: scale(1.02);
            transition: background-color 0.3s ease;
        }

        body.dark-mode .drop-zone.dragover {
            background-color: #444 !important;
        }

        .folder.dragover>span {
            background-color: #d1e7ff;
            border: 2px dashed #4285f4;
            transform: scale(1.03);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        body.dark-mode .folder.dragover>span {
            background-color: #555 !important;
            border-color: #3267d6;
        }

        .folder {
            padding: 2px;
            list-style: none;
        }

        .folder .material-symbols-outlined {
            font-size: 28px;
            color: #999;
            margin-right: 5px;
            font-variation-settings:
                'FILL' 1,
                'wght' 100,
                'GRAD' 0,
                'opsz' 24
        }

        .folder-list-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            transition: color 0.3s ease;
        }

        /* Bottom Bar */
        .bottom-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            font-weight: 500;
            color: #666;
            transition: background-color 0.3s ease, border-top-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode .bottom-bar {
            background-color: #333 !important;
            border-top-color: #555;
            color: #ddd !important;
        }

        .bottom-bar button {
            display: flex;
            align-items: center;
            gap: 3px;
            background-color: transparent;
            color: #c01ca8;
            background: #fbd5f5;
            padding: 3px 8px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .bottom-bar button .material-symbols-outlined {
            font-size: 18px;
            font-variation-settings:
                'FILL' 1,
                'wght' 100,
                'GRAD' 0,
                'opsz' 24
        }

        body.dark-mode .bottom-bar button {
            color: #c01ca8 !important;
            /* Lighter purple for dark mode */
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 10px;
            width: 200px;
            font-size: 14px;
            display: none;
            z-index: 1001;
            /* Increased to ensure visibility */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }

        body.dark-mode .context-menu {
            background-color: #555 !important;
        }

        .context-menu ul {
            list-style: none;
            margin-top: 0;
            padding: 0;
        }

        .context-menu li {
            padding: 5px 0;
            cursor: pointer;
            position: relative;
        }

        .context-menu li.title {
            cursor: default;
            font-weight: 200;
            color: #ccc;
            border-top: 1px solid #444;
            margin-top: 10px;
            padding-bottom: 2px;
        }

        .context-menu li:hover:not(.title),
        .context-menu li.active:not(.title) {
            background-color: #4285f4;
        }

        .color-tags {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .color-tag {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            cursor: pointer;
        }

        .color-tag.add {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: gray;
            color: white;
            font-size: 12px;
        }

        /* Favorite and Color Tag Indicators */
        .favorite-indicator {
            position: absolute;
            right: 40px;
            margin-left: 5px;
            color: #FFD700;
            display: flex;
            justify-content: flex-end;
        }

        .folder-favorite-indicator {
            position: absolute;
            right: 40px;
            margin-left: 5px;
            color: #FFD700;
            display: flex;
            justify-content: flex-end;
        }

        .file-structure.grid-view .favorite-indicator {
            margin-left: 0;
            margin-top: 5px;
        }

        .color-tag-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 7px 10px 0 10px;
        }

        .folder-color-tag-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 7px 10px 0 10px;
        }

        .file-structure.grid-view .color-tag-indicator {
            margin-left: 0;
            margin-top: 5px;
        }

        /* Hidden File Input */
        #file-input {
            display: none;
        }

        /* Move to Folder and Add to Project Submenu */
        .move-submenu,
        .project-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background-color: #333;
            color: white;
            padding: 10px;
            list-style: none;
            z-index: 1002;
            /* Higher than context menu */
            display: none;
            transition: background-color 0.3s ease;
        }

        body.dark-mode .move-submenu,
        body.dark-mode .project-submenu {
            background-color: #555 !important;
        }

        .project-submenu li,
        .move-submenu li {
            padding: 5px 0;
            cursor: pointer;
        }

        .project-submenu li:hover,
        .move-submenu li:hover {
            background-color: #4285f4;
        }

        .project-submenu li.disabled,
        .move-submenu li.disabled {
            color: #888;
            cursor: default;
        }

        .project-submenu li.disabled:hover,
        .move-submenu li.disabled:hover {
            background-color: transparent;
        }
    </style>
</head>

<body>
    <div class="mobile-view">
        <header>
            <div class="header-top">
                <div class="toggle-label">Turn on preview</div>
                <div class="toggle-right">
                    <div class="toggle-switch">
                        <input type="checkbox" id="preview-toggle">
                        <span class="slider"></span>
                    </div>
                    <button class="double-arrow" title="Show File Tree"><span class="material-symbols-outlined">
                            keyboard_double_arrow_right
                        </span></button>
                </div>
            </div>
            <div class="header-bottom">
                <div class="navigation">
                    <button class="back"><span class="material-symbols-outlined">
                            arrow_back_ios_new
                        </span></button>
                </div>
                <div class="project-dropdown">Project 1
                    <span class="material-icons">keyboard_arrow_down</span>
                    <ul class="project-dropdown-menu">
                        <!-- Projects will be populated here -->
                    </ul>
                </div>
                <div class="icons">
                    <button class="new-folder" title="New Folder"><span class="material-symbols-outlined">
                            create_new_folder
                        </span></button>
                    <button class="search" title="Search"><span class="material-symbols-outlined">
                            search
                        </span></button>
                    <div class="search-bar">
                        <div class="search-details">
                            <input type="text" id="search-input" placeholder="Search files and folders...">
                        <button id="clear-search">Clear</button>
                        </div>
                    </div>
                    <button title="Toggle Layout"><span class="material-symbols-outlined layout">
                            filter_list
                        </span></button>
                    <button class="sort-filter" title="Sort/Filter"><span class="material-symbols-outlined">
                            swap_vert
                        </span></button>
                    <button class="new-project" title="New Project"><span class="material-symbols-outlined">
                            view_agenda
                        </span></button>
                </div>
            </div>
        </header>
        <div class="content">
            <aside class="sidebar">
                <ul class="file-structure">
                    <!-- File structure will populate here -->
                </ul>
            </aside>
            <main class="main-area">
                <div class="drop-zone">
                    <div class="icon"><span class="material-symbols-outlined">
                            south
                        </span></div>
                    <p>Drop items here</p>
                </div>
            </main>
        </div>
        <footer class="bottom-bar">
            <span>Up to 200 MB per file</span>
            <button><span class="material-symbols-outlined">
                    crown
                </span>Increase limit</button>
        </footer>
    </div>
    <div class="context-menu" style="display: none;">
        <ul>
            <li class="upload-file">Upload File</li>
            <li class="new-subfolder">New Subfolder</li>
            <li class="rename">Rename</li>
            <li class="favorite">Favorite</li>
            <li class="move-to-folder">Move to folder
                <ul class="move-submenu"></ul>
            </li>
            <li class="add-to-project">Add to project
                <ul class="project-submenu"></ul>
            </li>
            <li class="more-info">More info</li>
            <li class="delete">Delete</li>
            <li class="title">Color tag</li>
        </ul>
        <div class="color-tags">
            <div class="color-tag" style="background-color: orange;" data-color="orange"></div>
            <div class="color-tag" style="background-color: purple;" data-color="purple"></div>
            <div class="color-tag" style="background-color: blue;" data-color="blue"></div>
            <div class="color-tag" style="background-color: green;" data-color="green"></div>
            <div class="color-tag" style="background-color: yellow;" data-color="yellow"></div>
            <div class="color-tag" style="background-color: red;" data-color="red"></div>
            <div class="color-tag add">+</div>
        </div>
    </div>
    <div class="sort-filter-menu" style="display: none;">
        <ul>
            <li class="title">Sort By</li>
            <li class="sort" data-sort="name-asc">Name (A-Z)</li>
            <li class="sort" data-sort="name-desc">Name (Z-A)</li>
            <li class="sort" data-sort="type">Type</li>
            <li class="title">Filter By</li>
            <li class="filter" data-filter="all">All</li>
            <li class="filter" data-filter="favorites">Favorites</li>
            <li class="filter" data-filter="images">Images</li>
            <li class="filter" data-filter="videos">Videos</li>
            <li class="filter" data-filter="audio">Audio</li>
            <li class="filter" data-filter="documents">Documents</li>
        </ul>
    </div>
    <input type="file" id="file-input" multiple style="display: none;">

    <script>
        // Project Management System
        let projects = [
            {
                name: 'Project 1',
                type: 'folder',
                favorite: false,
                colorTag: null,
                children: [],
                layout: 'list',
                sortBy: 'name-asc', // Default sort: Name A-Z
                filterBy: 'all' // Default filter: All
            }
        ];
        let currentProjectIndex = 0;
        let isSidebarForcedOpen = false; // Track if sidebar is forced open by double arrow
        let isFileTreeExpanded = false; // Track if file tree is recursively expanded
        let folderExpansionStates = {}; // Store expansion state of each folder by path
        const fileStructure = document.querySelector('.file-structure');
        const sidebar = document.querySelector('.sidebar');
        const dropZone = document.querySelector('.drop-zone');
        const fileInput = document.getElementById('file-input');
        const projectDropdown = document.querySelector('.project-dropdown');
        const projectDropdownMenu = document.querySelector('.project-dropdown-menu');
        const searchBar = document.querySelector('.search-bar');
        const searchInput = document.getElementById('search-input');
        const clearSearchButton = document.getElementById('clear-search');
        const layoutButton = document.querySelector('.layout');
        const sortFilterButton = document.querySelector('.sort-filter');
        const sortFilterMenu = document.querySelector('.sort-filter-menu');
        let selectedPath = null;
        let selectedType = null;
        let selectedItemName = null;
        let draggedPath = null;
        let draggedType = null;
        let draggedItemName = null;
        let currentSearchQuery = '';

        function getCurrentProject() {
            return projects[currentProjectIndex];
        }

        function populateProjectDropdown() {
            projectDropdownMenu.innerHTML = '';
            projects.forEach((project, index) => {
                const li = document.createElement('li');
                li.textContent = project.name;
                li.setAttribute('data-index', index);
                if (index === currentProjectIndex) {
                    li.style.fontWeight = 'bold';
                }
                projectDropdownMenu.appendChild(li);
            });
        }

        // Check if a node matches the search query
        function matchesSearchQuery(node, query) {
            if (!query) return true;
            const lowerQuery = query.toLowerCase();
            const matchesName = node.name.toLowerCase().includes(lowerQuery);
            if (matchesName) return true;
            if (node.type === 'folder') {
                return node.children.some(child => matchesSearchQuery(child, query));
            }
            return false;
        }

        // Check if a node matches the filter criteria
        function matchesFilter(node, filterBy) {
            if (filterBy === 'all') return true;
            if (filterBy === 'favorites') return node.favorite;
            if (node.type === 'folder') {
                return node.children.some(child => matchesFilter(child, filterBy));
            }
            if (filterBy === 'images') return node.name.endsWith('.png');
            if (filterBy === 'videos') return node.name.endsWith('.mp4');
            if (filterBy === 'audio') return node.name.endsWith('.mp3');
            if (filterBy === 'documents') {
                return !node.name.endsWith('.png') && !node.name.endsWith('.mp4') && !node.name.endsWith('.mp3');
            }
            return false;
        }

        // Sort children based on sortBy criteria
        function sortChildren(children, sortBy) {
            const sorted = [...children];
            if (sortBy === 'name-asc') {
                sorted.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'name-desc') {
                sorted.sort((a, b) => b.name.localeCompare(b.name));
            } else if (sortBy === 'type') {
                sorted.sort((a, b) => {
                    if (a.type === b.type) {
                        return a.name.localeCompare(b.name);
                    }
                    return a.type === 'folder' ? -1 : 1;
                });
            }
            return sorted;
        }

        function renderFileTree(node, parentElement, path = [], query = '') {
            const currentProject = getCurrentProject();
            const layout = currentProject.layout || 'list';
            const sortBy = currentProject.sortBy || 'name-asc';
            const filterBy = currentProject.filterBy || 'all';

            // Apply search filter first
            if (!matchesSearchQuery(node, query)) {
                return false;
            }

            // Apply additional filter
            let matchesFilterCriteria = matchesFilter(node, filterBy);
            if (node.type === 'folder') {
                matchesFilterCriteria = matchesFilterCriteria || node.children.some(child => matchesFilter(child, filterBy));
            }
            if (!matchesFilterCriteria && node.type !== 'folder') {
                return false;
            }

            fileStructure.className = `file-structure ${layout}-view`;

            const li = document.createElement('li');
            let hasVisibleChildren = false;

            if (node.type === 'folder') {
                li.className = 'folder';
                const currentPath = [...path, node.name];
                const pathKey = currentPath.join('/');
                li.setAttribute('data-path', JSON.stringify(currentPath));
                li.setAttribute('data-type', 'folder');

                const folderContent = document.createElement('span');
                folderContent.className = 'draggable-folder-span';
                folderContent.setAttribute('draggable', 'true');
                const arrowDiv = document.createElement('div');
                const arrowSpan = document.createElement('span');
                arrowSpan.className = 'arrow';
                arrowSpan.textContent = '▶';
                arrowDiv.appendChild(arrowSpan);

                const folderDiv = document.createElement('div');
                const folderIcon = document.createElement('span');
                folderIcon.className = 'folder-icon material-symbols-outlined';
                folderIcon.textContent = 'folder';
                folderDiv.appendChild(folderIcon);

                const nameDiv = document.createElement('div');
                const nameSpan = document.createElement('span');
                nameSpan.className = layout === 'grid' ? 'folder-name' : 'folder-list-name';
                nameSpan.textContent = node.name;
                nameDiv.appendChild(nameSpan);

                const arrowFolderIconNameDiv = document.createElement('div');
                arrowFolderIconNameDiv.className = 'arrow-name-div';
                arrowFolderIconNameDiv.appendChild(arrowDiv);
                arrowFolderIconNameDiv.appendChild(folderDiv);
                arrowFolderIconNameDiv.appendChild(nameDiv);

                const favoriteColorDiv = document.createElement('div');
                favoriteColorDiv.className = 'folder-favorite-color-div';

                // create favorite and color tag indicators
                const favoriteIndicator = document.createElement('span');
                const colorTagIndicator = document.createElement('span');


                if (node.favorite) {
                    favoriteIndicator.className = 'folder-favorite-indicator';
                    favoriteIndicator.textContent = '★';
                    favoriteColorDiv.appendChild(favoriteIndicator);
                    favoriteColorDiv.appendChild(colorTagIndicator);
                }

                if (node.colorTag) {
                    console.log(`Rendering color tag for ${node.name}: ${node.colorTag}`);
                    colorTagIndicator.className = 'folder-color-tag-indicator';
                    colorTagIndicator.style.backgroundColor = node.colorTag;
                    favoriteColorDiv.appendChild(favoriteIndicator);
                    favoriteColorDiv.appendChild(colorTagIndicator);
                }

                folderContent.appendChild(arrowFolderIconNameDiv);
                folderContent.appendChild(favoriteColorDiv);

                li.appendChild(folderContent);

                const ul = document.createElement('ul');
                ul.style.display = 'none';
                const sortedChildren = sortChildren(node.children, sortBy);
                sortedChildren.forEach((child) => {
                    const childVisible = renderFileTree(child, ul, currentPath, query);
                    if (childVisible) {
                        hasVisibleChildren = true;
                    }
                });
                li.appendChild(ul);

                // Apply the expansion state from folderExpansionStates
                if (hasVisibleChildren || matchesFilter(node, filterBy) || node.name.toLowerCase().includes(query.toLowerCase())) {
                    const isExpanded = folderExpansionStates[pathKey] !== undefined ? folderExpansionStates[pathKey] : isFileTreeExpanded;
                    ul.style.display = isExpanded ? 'block' : 'none';
                    arrowSpan.textContent = isExpanded ? '▼' : '▶';
                }

                li.querySelector('span').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const childrenUl = li.querySelector('ul');
                    const isCurrentlyExpanded = childrenUl.style.display === 'block';
                    childrenUl.style.display = isCurrentlyExpanded ? 'none' : 'block';
                    const arrow = li.querySelector('.arrow');
                    arrow.textContent = isCurrentlyExpanded ? '▶' : '▼';
                    // Update the expansion state
                    folderExpansionStates[pathKey] = !isCurrentlyExpanded;
                });

                li.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    li.classList.add('dragover');
                });
                li.addEventListener('dragleave', (e) => {
                    e.stopPropagation();
                    li.classList.remove('dragover');
                });
                li.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    li.classList.remove('dragover');

                    const targetPath = JSON.parse(li.getAttribute('data-path'));
                    const files = e.dataTransfer.files;

                    if (files && files.length > 0) {
                        addFilesToFolder(Array.from(files), targetPath);
                    } else if (draggedPath) {
                        moveItem(draggedPath, targetPath, draggedType, draggedItemName);
                        draggedPath = null;
                        draggedType = null;
                        draggedItemName = null;
                    }
                });

                folderContent.addEventListener('dragstart', (e) => {
                    draggedPath = JSON.parse(li.getAttribute('data-path'));
                    draggedType = li.getAttribute('data-type');
                    draggedItemName = draggedPath[draggedPath.length - 1];
                    e.dataTransfer.setData('text/plain', '');
                });
            } else {
                if (!query || node.name.toLowerCase().includes(query.toLowerCase())) {
                    if (!matchesFilter(node, filterBy)) {
                        return false;
                    }

                    li.className = 'file';
                    li.setAttribute('data-type', 'file');
                    const fileContent = document.createElement('span');
                    fileContent.className = 'draggable-file-span';
                    fileContent.setAttribute('draggable', 'true');
                    const icon = node.name.endsWith('.png')
                        ? `<img src="https://i.pinimg.com/136x136/a1/ee/78/a1ee78fb2dd77ec2054655392f23d7de.jpg" alt="${node.name}" style="width: 20px; height: 20px; border-radius: 0px; ">` :
                        node.name.endsWith('.jpg') || node.name.endsWith('.jpeg') ? `<img src="https://i.pinimg.com/136x136/a1/ee/78/a1ee78fb2dd77ec2054655392f23d7de.jpg" alt="${node.name}" style="width: 20px; height: 20px; border-radius: 0px; ">` :
                            node.name.endsWith('.mp4') ? `<img src="https://image.winudf.com/v2/image1/Y29tLmZhbnRvbS50di5tZWRpYV9zY3JlZW5fM18xNjMxNzgwNTEzXzAxMw/screen-3.jpg?h=200&fakeurl=1&type=.jpg" alt="${node.name}" style="width: 20px; height: 20px; border-radius: 0px; ">` :
                                node.name.endsWith('.pdf') ? `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/PDF_file_icon.svg/833px-PDF_file_icon.svg.png" alt="${node.name}" style="width: 20px; height: 22px; border-radius: 0px; ">` :
                                    node.name.endsWith('.mp3') ? '🎵' : '📄';
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'icon';

                    // Check if the icon is an HTML string (e.g., <img>) or plain text
                    if (node.name.endsWith('.png') || node.name.endsWith('.jpg') || node.name.endsWith('.jpeg') || node.name.endsWith('.mp4') || node.name.endsWith('.pdf') || node.name.endsWith('.mp3')) {
                        iconSpan.innerHTML = icon; // Use innerHTML for HTML content
                    } else {
                        iconSpan.textContent = icon; // Use textContent for plain text
                    }

                    // fileContent.appendChild(iconSpan);
                    const nameSpan = document.createElement('div');
                    nameSpan.className = layout === 'grid' ? 'file-name' : 'file-list-name';
                    nameSpan.style.paddingBottom = '5px';
                    nameSpan.textContent = node.name;
                    // fileContent.appendChild(nameSpan);

                    const iconNameDiv = document.createElement('div');
                    const favoriteColorDiv = document.createElement('div');
                    iconNameDiv.className = 'icon-name-div';
                    favoriteColorDiv.className = 'favorite-color-div';
                    iconNameDiv.appendChild(iconSpan);
                    iconNameDiv.appendChild(nameSpan);

                    // create favorite and color tag indicators
                    const favoriteIndicator = document.createElement('span');
                    const colorTagIndicator = document.createElement('span');

                    if (node.favorite) {

                        favoriteIndicator.className = 'favorite-indicator';
                        favoriteIndicator.textContent = '★';
                        favoriteColorDiv.appendChild(favoriteIndicator);
                        favoriteColorDiv.appendChild(colorTagIndicator);
                        // fileContent.appendChild(favoriteIndicator);
                    }

                    if (node.colorTag) {
                        console.log(`Rendering color tag for ${node.name}: ${node.colorTag}`);
                        colorTagIndicator.className = 'color-tag-indicator';
                        colorTagIndicator.style.backgroundColor = node.colorTag;
                        favoriteColorDiv.appendChild(favoriteIndicator);
                        favoriteColorDiv.appendChild(colorTagIndicator);
                        // fileContent.appendChild(colorTagIndicator);
                    }

                    // append iconNameDiv and favoriteColorDiv to fileContent
                    fileContent.appendChild(iconNameDiv);
                    fileContent.appendChild(favoriteColorDiv);

                    li.appendChild(fileContent);
                    li.setAttribute('data-path', JSON.stringify([...path, node.name]));

                    fileContent.addEventListener('dragstart', (e) => {
                        draggedPath = JSON.parse(li.getAttribute('data-path'));
                        draggedType = li.getAttribute('data-type');
                        draggedItemName = draggedPath[draggedPath.length - 1];
                        e.dataTransfer.setData('text/plain', '');
                    });
                    parentElement.appendChild(li);
                    return true;
                }
                return false;
            }

            if (matchesFilter(node, filterBy) || node.name.toLowerCase().includes(query.toLowerCase()) || hasVisibleChildren) {
                parentElement.appendChild(li);
                return true;
            }
            return false;
        }

        function refreshFileTree(query = currentSearchQuery) {
            fileStructure.innerHTML = '';
            const currentProject = getCurrentProject();
            const hasVisibleItems = renderFileTree(currentProject, fileStructure, [], query);
            const hasContent = currentProject.children.length > 0;
            // Show sidebar if forced open or if there are visible items; otherwise show drop zone
            sidebar.style.display = isSidebarForcedOpen || (hasContent && hasVisibleItems) ? 'block' : 'none';
            dropZone.style.display = isSidebarForcedOpen || (hasContent && hasVisibleItems) ? 'none' : 'flex';
            projectDropdown.firstChild.textContent = currentProject.name;
            populateProjectDropdown();
            layoutButton.textContent = currentProject.layout === 'list' ? 'filter_list' : 'grid_view';
        }

        function addFilesToFolder(files, path) {
            // Preserve the current state of the sidebar
            const wasSidebarForcedOpen = isSidebarForcedOpen;

            let current = getCurrentProject();
            for (const folderName of path.slice(1)) {
                current = current.children.find(child => child.name === folderName && child.type === 'folder');
                if (!current) {
                    console.error('Folder not found:', folderName, 'in path:', path);
                    return;
                }
            }
            files.forEach(file => {
                current.children.push({
                    name: file.name,
                    type: 'file',
                    favorite: false,
                    colorTag: null
                });
            });

            // Restore the sidebar state before refreshing
            isSidebarForcedOpen = wasSidebarForcedOpen;
            // folderExpansionStates is preserved automatically
            refreshFileTree();
        }

        function addFiles(files) {
            addFilesToFolder(files, [getCurrentProject().name]);
        }

        function createFolder(parentNode) {
            const folderName = prompt('Enter folder name:');
            if (folderName) {
                parentNode.children.push({
                    name: folderName,
                    type: 'folder',
                    favorite: false,
                    colorTag: null,
                    children: []
                });
                refreshFileTree();
            }
        }

        function findParentAndItemByPath(path, project = getCurrentProject()) {
            if (path.length <= 1) {
                return { parent: null, item: project };
            }
            let parent = project;
            for (const name of path.slice(1, -1)) {
                parent = parent.children.find(child => child.name === name && child.type === 'folder');
                if (!parent) return { parent: null, item: null };
            }
            const item = parent.children.find(child => child.name === path[path.length - 1]);
            return { parent, item };
        }

        function collectFolders(node, path = [], excludePath = []) {
            const folders = [];
            if (node.type === 'folder') {
                const currentPath = [...path, node.name];
                const isExcluded = currentPath.length >= excludePath.length &&
                    currentPath.slice(0, excludePath.length).every((val, idx) => val === excludePath[idx]);
                if (!isExcluded) {
                    folders.push({ name: node.name, path: currentPath });
                }
                node.children.forEach(child => {
                    if (child.type === 'folder') {
                        folders.push(...collectFolders(child, currentPath, excludePath));
                    }
                });
            }
            return folders;
        }

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        });

        document.addEventListener('contextmenu', (e) => {
            const fileElement = e.target.closest('.file');
            const folderElement = e.target.closest('.folder');
            const targetElement = fileElement || folderElement;

            if (targetElement) {
                e.preventDefault();
                e.stopPropagation();

                selectedPath = JSON.parse(targetElement.getAttribute('data-path'));
                selectedType = targetElement.getAttribute('data-type');
                selectedItemName = selectedPath[selectedPath.length - 1];

                const contextMenu = document.querySelector('.context-menu');
                const targetRect = targetElement.getBoundingClientRect();

                // Adjust position to move the context menu closer to the clicked element
                let x = targetRect.right - 250; 
                let y = targetRect.top + 30; 

                // Ensure the context menu stays within the viewport
                const menuWidth = contextMenu.offsetWidth || 200; 
                const menuHeight = contextMenu.offsetHeight || 300;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                if (x + menuWidth > viewportWidth) {
                    x = targetRect.left - menuWidth - 10; 
                }
                if (y + menuHeight > viewportHeight) {
                    y = viewportHeight - menuHeight - 10;
                }

                contextMenu.style.left = `${x}px`;
                contextMenu.style.top = `${y}px`;
                contextMenu.style.display = 'block';

                document.querySelector('.upload-file').style.display = selectedType === 'folder' ? 'block' : 'none';
                document.querySelector('.new-subfolder').style.display = selectedType === 'folder' ? 'block' : 'none';

                const projectSubmenu = document.querySelector('.project-submenu');
                projectSubmenu.innerHTML = '';
                if (projects.length <= 1) {
                    const li = document.createElement('li');
                    li.textContent = 'Create another project to use this';
                    li.className = 'disabled';
                    projectSubmenu.appendChild(li);
                } else {
                    projects.forEach((project, index) => {
                        if (index !== currentProjectIndex) {
                            const li = document.createElement('li');
                            li.textContent = project.name;
                            li.setAttribute('data-project-index', index);
                            projectSubmenu.appendChild(li);
                        }
                    });
                }

                const moveSubmenu = document.querySelector('.move-submenu');
                moveSubmenu.innerHTML = '';
                const folders = collectFolders(getCurrentProject(), [], selectedPath);
                folders.forEach(folder => {
                    const li = document.createElement('li');
                    li.textContent = folder.name;
                    li.setAttribute('data-path', JSON.stringify(folder.path));
                    moveSubmenu.appendChild(li);
                });
            }
        });

        const addToProjectLi = document.querySelector('.add-to-project');
        const projectSubmenu = document.querySelector('.project-submenu');
        const moveToFolderLi = document.querySelector('.move-to-folder');
        const moveSubmenu = document.querySelector('.move-submenu');

        addToProjectLi.addEventListener('mouseenter', () => {
            projectSubmenu.style.display = 'block';
        });
        projectSubmenu.addEventListener('mouseenter', () => {
            projectSubmenu.style.display = 'block';
        });
        addToProjectLi.addEventListener('mouseleave', (e) => {
            if (!projectSubmenu.contains(e.relatedTarget)) {
                projectSubmenu.style.display = 'none';
            }
        });
        projectSubmenu.addEventListener('mouseleave', (e) => {
            if (!addToProjectLi.contains(e.relatedTarget)) {
                projectSubmenu.style.display = 'none';
            }
        });

        moveToFolderLi.addEventListener('mouseenter', () => {
            moveSubmenu.style.display = 'block';
        });
        moveSubmenu.addEventListener('mouseenter', () => {
            moveSubmenu.style.display = 'block';
        });
        moveToFolderLi.addEventListener('mouseleave', (e) => {
            if (!moveSubmenu.contains(e.relatedTarget)) {
                moveSubmenu.style.display = 'none';
            }
        });
        moveSubmenu.addEventListener('mouseleave', (e) => {
            if (!moveToFolderLi.contains(e.relatedTarget)) {
                moveSubmenu.style.display = 'none';
            }
        });

        projectSubmenu.addEventListener('click', (e) => {
            const target = e.target.closest('li');
            if (target && !target.classList.contains('disabled')) {
                e.stopPropagation();
                const projectIndex = parseInt(target.getAttribute('data-project-index'));
                if (!isNaN(projectIndex)) {
                    addToProject(projectIndex);
                    document.querySelector('.context-menu').style.display = 'none';
                }
            }
        });

        moveSubmenu.addEventListener('click', (e) => {
            const target = e.target.closest('li');
            if (target) {
                e.stopPropagation();
                const targetPath = JSON.parse(target.getAttribute('data-path'));
                moveItem(selectedPath, targetPath, selectedType, selectedItemName);
                document.querySelector('.context-menu').style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            const contextMenu = document.querySelector('.context-menu');
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
            const dropdownMenu = document.querySelector('.project-dropdown-menu');
            if (!projectDropdown.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.style.display = 'none';
            }
            const sortFilterMenu = document.querySelector('.sort-filter-menu');
            if (!sortFilterButton.contains(e.target) && !sortFilterMenu.contains(e.target)) {
                sortFilterMenu.style.display = 'none';
            }
            const searchBar = document.querySelector('.search-bar');
            const searchButton = document.querySelector('.search');
            if (!searchBar.contains(e.target) && !searchButton.contains(e.target)) {
                searchBar.style.display = 'none';
                currentSearchQuery = '';
                searchInput.value = '';
                refreshFileTree();
            }
        });

        projectDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
            projectDropdownMenu.style.display = projectDropdownMenu.style.display === 'block' ? 'none' : 'block';
        });

        projectDropdownMenu.addEventListener('click', (e) => {
            const target = e.target.closest('li');
            if (target) {
                const index = parseInt(target.getAttribute('data-index'));
                currentProjectIndex = index;
                selectedPath = null;
                selectedType = null;
                selectedItemName = null;
                refreshFileTree();
                projectDropdownMenu.style.display = 'none';
            }
        });

        document.querySelector('.upload-file').addEventListener('click', () => {
            if (selectedPath && selectedType === 'folder') {
                fileInput.click();
            }
        });
        fileInput.addEventListener('change', () => {
            const files = Array.from(fileInput.files);
            if (selectedPath && files.length > 0) {
                addFilesToFolder(files, selectedPath);
            }
            fileInput.value = '';
        });

        document.querySelector('.new-subfolder').addEventListener('click', () => {
            if (selectedPath && selectedType === 'folder') {
                let current = getCurrentProject();
                for (const folderName of selectedPath.slice(1)) {
                    current = current.children.find(child => child.name === folderName && child.type === 'folder');
                    if (!current) return;
                }
                createFolder(current);
            }
        });

        document.querySelector('.rename').addEventListener('click', () => {
            if (selectedPath && selectedType) {
                const newName = prompt('Enter new name:', selectedPath[selectedPath.length - 1]);
                if (newName) {
                    const { parent, item } = findParentAndItemByPath(selectedPath);
                    if (item) {
                        item.name = newName;
                        refreshFileTree();
                    }
                }
            }
        });

        document.querySelector('.more-info').addEventListener('click', () => {
            if (selectedPath && selectedType) {
                const { item } = findParentAndItemByPath(selectedPath);
                if (item) {
                    const info = `Name: ${item.name}\nType: ${item.type}\nPath: ${selectedPath.join('/')}\nFavorite: ${item.favorite ? 'Yes' : 'No'}\nColor Tag: ${item.colorTag || 'None'}`;
                    alert(info);
                }
            }
        });

        document.querySelector('.favorite').addEventListener('click', () => {
            if (selectedPath && selectedType) {
                const { item } = findParentAndItemByPath(selectedPath);
                if (item) {
                    item.favorite = !item.favorite;
                    refreshFileTree();
                }
            }
        });

        document.querySelectorAll('.color-tag').forEach(tag => {
            tag.addEventListener('click', (e) => {
                e.stopPropagation();
                if (selectedPath && selectedType) {
                    const { item } = findParentAndItemByPath(selectedPath);
                    if (item) {
                        const color = e.target.getAttribute('data-color');
                        item.colorTag = color ? color : null;
                        console.log(`Set color tag for ${item.name} to ${item.colorTag}`);
                        refreshFileTree();
                    }
                }
                document.querySelector('.context-menu').style.display = 'none';
            });
        });

        document.querySelector('.delete').addEventListener('click', () => {
            if (selectedPath) {
                const { parent } = findParentAndItemByPath(selectedPath);
                if (parent) {
                    parent.children = parent.children.filter(child => child.name !== selectedPath[selectedPath.length - 1]);
                    refreshFileTree();
                } else if (selectedPath.length === 1 && selectedPath[0] === getCurrentProject().name) {
                    alert('Cannot delete the root project.');
                }
            }
        });

        function moveItem(sourcePath, targetPath, sourceType, itemName) {
            if (!sourcePath || !sourceType) {
                console.error('No item selected for moving.');
                return;
            }

            if (JSON.stringify(sourcePath) === JSON.stringify(targetPath)) {
                alert('Cannot move item to its current location.');
                return;
            }

            const { parent, item } = findParentAndItemByPath(sourcePath);
            if (!parent || !item) {
                console.error('Parent or item not found for path:', sourcePath);
                return;
            }

            if (sourceType === 'folder') {
                let currentPath = [...targetPath];
                while (currentPath.length > 0) {
                    if (JSON.stringify(currentPath) === JSON.stringify(sourcePath)) {
                        alert('Cannot move a folder into itself or its descendants.');
                        return;
                    }
                    currentPath.pop();
                }
            }

            if (parent) {
                parent.children = parent.children.filter(child => child.name !== item.name);
            } else {
                console.error('Cannot move the root project.');
                return;
            }

            let target = getCurrentProject();
            for (const folderName of targetPath.slice(1)) {
                target = target.children.find(child => child.name === folderName && child.type === 'folder');
                if (!target) {
                    console.error('Target folder not found:', folderName, 'in path:', targetPath);
                    return;
                }
            }

            target.children.push(item);
            alert(`"${itemName}" moved to ${targetPath[targetPath.length - 1]}.`);
            selectedPath = null;
            selectedType = null;
            selectedItemName = null;
            refreshFileTree();
        }

        function addToProject(targetProjectIndex) {
            if (!selectedPath || !selectedType) {
                console.error('No item selected for adding to project.');
                return;
            }

            const { parent, item } = findParentAndItemByPath(selectedPath);
            if (!parent || !item) {
                console.error('Parent or item not found for path:', selectedPath);
                return;
            }

            if (selectedPath.length === 1 && selectedPath[0] === getCurrentProject().name) {
                alert('Cannot move the root project to another project.');
                return;
            }

            parent.children = parent.children.filter(child => child.name !== item.name);
            projects[targetProjectIndex].children.push(item);
            alert(`"${selectedItemName}" moved to ${projects[targetProjectIndex].name}.`);
            selectedPath = null;
            selectedType = null;
            selectedItemName = null;
            refreshFileTree();
        }

        document.querySelector('.new-folder').addEventListener('click', () => {
            createFolder(getCurrentProject());
        });

        document.querySelector('.new-project').addEventListener('click', () => {
            try {
                const projectName = prompt('Enter new project name:');
                if (projectName) {
                    projects.push({
                        name: projectName,
                        type: 'folder',
                        favorite: false,
                        colorTag: null,
                        children: [],
                        layout: 'list',
                        sortBy: 'name-asc',
                        filterBy: 'all'
                    });
                    console.log('Projects after adding new project:', projects);
                    alert(`Project "${projectName}" created. Switch to it using the project dropdown.`);
                    refreshFileTree();
                }
            } catch (error) {
                console.error('Failed to create new project:', error);
                alert('Failed to create new project. Please ensure pop-ups are enabled or try again.');
            }
        });

        const previewToggle = document.getElementById('preview-toggle');
        const toggleSwitch = document.querySelector('.toggle-switch');
        const slider = toggleSwitch.querySelector('.slider');

        // Ensure the change event fires and logs the state
        previewToggle.addEventListener('change', () => {
            console.log('Preview toggle changed, checked:', previewToggle.checked);
            if (previewToggle.checked) {
                document.body.classList.add('dark-mode');
                console.log('Dark mode enabled');
            } else {
                document.body.classList.remove('dark-mode');
                console.log('Light mode enabled');
            }
        });

        // Fallback: Click on the slider to toggle the checkbox
        slider.addEventListener('click', (e) => {
            e.stopPropagation();
            previewToggle.checked = !previewToggle.checked;
            previewToggle.dispatchEvent(new Event('change'));
        });

        const doubleArrow = document.querySelector('.double-arrow');
        doubleArrow.addEventListener('click', () => {
            isSidebarForcedOpen = !isSidebarForcedOpen;
            if (isSidebarForcedOpen) {
                isFileTreeExpanded = true;
                // Expand all folders
                for (let pathKey in folderExpansionStates) {
                    folderExpansionStates[pathKey] = true;
                }
                sidebar.style.display = 'block';
                dropZone.style.display = 'none';
                doubleArrow.textContent = '«';
                doubleArrow.title = 'Hide File Tree';
                refreshFileTree();
            } else {
                isFileTreeExpanded = false;
                // Collapse all folders
                for (let pathKey in folderExpansionStates) {
                    folderExpansionStates[pathKey] = false;
                }
                const currentProject = getCurrentProject();
                const hasContent = currentProject.children.length > 0;
                const hasVisibleItems = fileStructure.children.length > 0;
                sidebar.style.display = hasContent && hasVisibleItems ? 'block' : 'none';
                dropZone.style.display = hasContent && hasVisibleItems ? 'none' : 'flex';
                doubleArrow.textContent = '»';
                doubleArrow.title = 'Show File Tree';
                refreshFileTree();
            }
        });

        document.querySelector('.search').addEventListener('click', (e) => {
            e.stopPropagation();
            searchBar.style.display = 'block';
            searchInput.focus();
        });

        searchInput.addEventListener('input', (e) => {
            currentSearchQuery = e.target.value;
            refreshFileTree(currentSearchQuery);
        });

        clearSearchButton.addEventListener('click', (e) => {
            e.stopPropagation();
            currentSearchQuery = '';
            searchInput.value = '';
            searchBar.style.display = 'none';
            refreshFileTree();
        });

        layoutButton.addEventListener('click', () => {
            const currentProject = getCurrentProject();
            currentProject.layout = currentProject.layout === 'list' ? 'grid' : 'list';
            refreshFileTree();
        });

        // Sort/Filter Functionality
        sortFilterButton.addEventListener('click', (e) => {
            e.stopPropagation();
            sortFilterMenu.style.display = sortFilterMenu.style.display === 'block' ? 'none' : 'block';
        });

        sortFilterMenu.addEventListener('click', (e) => {
            const sortItem = e.target.closest('.sort');
            const filterItem = e.target.closest('.filter');
            const currentProject = getCurrentProject();

            if (sortItem) {
                const sortBy = sortItem.getAttribute('data-sort');
                currentProject.sortBy = sortBy;
                refreshFileTree();
                sortFilterMenu.style.display = 'none';
            } else if (filterItem) {
                const filterBy = filterItem.getAttribute('data-filter');
                currentProject.filterBy = filterBy;
                refreshFileTree();
                sortFilterMenu.style.display = 'none';
            }
        });

        document.querySelector('.sort-filter').addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();

            const sortFilterMenu = document.querySelector('.sort-filter-menu');
            const buttonRect = e.target.getBoundingClientRect();

            // Position the menu close to the button
            let x = buttonRect.left; 
            let y = buttonRect.bottom + 5;

            // Ensure the menu stays within the viewport
            const menuWidth = sortFilterMenu.offsetWidth || 150; 
            const menuHeight = sortFilterMenu.offsetHeight || 200;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            if (x + menuWidth > viewportWidth) {
                x = viewportWidth - menuWidth - 10;
            }
            if (y + menuHeight > viewportHeight) {
                y = buttonRect.top - menuHeight - 5;
            }

            sortFilterMenu.style.left = `${x}px`;
            sortFilterMenu.style.top = `${y}px`;
            sortFilterMenu.style.display = 'block';
        });

        // Close the menu when clicking outside
        document.addEventListener('click', (e) => {
            const sortFilterMenu = document.querySelector('.sort-filter-menu');
            if (!sortFilterMenu.contains(e.target) && !e.target.classList.contains('sort-filter')) {
                sortFilterMenu.style.display = 'none';
            }
        });

        refreshFileTree();
    </script>
</body>
</html>
